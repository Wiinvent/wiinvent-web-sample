<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Welcome Screen Demo (No Video)</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --accent: #4f8cff;
      --ok: #34c759;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 16px;
      --rlg: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      background:
        radial-gradient(1200px 800px at 10% 20%, rgba(79,140,255,.18), transparent 60%),
        radial-gradient(900px 700px at 90% 15%, rgba(52,199,89,.10), transparent 55%),
        var(--bg);
      color: var(--text);
      overflow:hidden;
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:18px;
      padding:22px;
    }

    /* left panel */
    .side{
      background: var(--panel);
      border:1px solid var(--stroke);
      border-radius: var(--rlg);
      box-shadow: var(--shadow);
      padding:18px;
      display:flex;
      flex-direction:column;
      min-width:320px;
    }

    .brand{ display:flex; gap:12px; align-items:center; padding:10px 10px 14px; }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(145deg, rgba(79,140,255,.95), rgba(79,140,255,.35));
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.20);
      box-shadow:0 14px 40px rgba(79,140,255,.25);
    }
    .brand h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .card{
      background: var(--panel2);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      padding:14px;
      margin-top:12px;
    }
    .card-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .card-title strong{ font-size:13px; letter-spacing:.2px; }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      color: var(--muted);
      background: rgba(0,0,0,.18);
    }

    .row{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
      padding:6px 0;
      border-bottom:1px dashed rgba(255,255,255,.12);
    }
    .row:last-child{ border-bottom:none; }
    .k{ color:var(--muted); font-size:12px; }
    .v{ font-size:12px; }

    .actions{ display:flex; gap:10px; margin-top:14px; }
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 14px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height:44px;
      flex:1;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(0,0,0,.26); border-color: rgba(255,255,255,.26); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .btn-primary{
      background: linear-gradient(135deg, rgba(79,140,255,.95), rgba(79,140,255,.55));
      border-color: rgba(79,140,255,.55);
      box-shadow: 0 14px 45px rgba(79,140,255,.18);
    }
    .btn-primary:hover{
      background: linear-gradient(135deg, rgba(79,140,255,1), rgba(79,140,255,.62));
      border-color: rgba(79,140,255,.75);
    }

    .hint{
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
      line-height:1.45;
    }

    .log{ margin-top:12px; flex:1; overflow:auto; padding-right:6px; }
    .log pre{
      margin:0;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.85);
      font-size:12px;
      line-height:1.45;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 180px;
    }

    /* right stage */
    .stage{
      position:relative;
      border-radius: var(--rlg);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-rows: auto 1fr;
      min-height: 520px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }

    .left{ display:flex; align-items:center; gap:10px; }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.22);
    }
    .dot.on{ background: var(--ok); border-color: rgba(52,199,89,.65); box-shadow: 0 0 0 6px rgba(52,199,89,.12); }
    .title{ font-weight:900; letter-spacing:.3px; font-size:13px; }
    .right{ color: var(--muted); font-size:12px; display:flex; gap:12px; align-items:center; }

    .screen{
      position:relative;
      display:grid;
      place-items:center;
      padding:16px;
    }

    /* TV OFF overlay */
    .tv-off{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      background: radial-gradient(800px 400px at 50% 40%, rgba(255,255,255,.06), rgba(0,0,0,.55));
      opacity: 1;
      transition: opacity .2s ease;
      pointer-events:none;
    }
    .tv-off.hidden{ opacity:0; }

    .off-card{
      width: min(560px, 92%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      padding: 20px;
      text-align:center;
      backdrop-filter: blur(8px);
      box-shadow: 0 22px 80px rgba(0,0,0,.35);
    }
    .off-card h2{ margin:0; font-size:24px; letter-spacing:.2px; }
    .off-card p{ margin:8px 0 0; color: var(--muted); font-size:14px; line-height:1.5; }

    /* Welcome UI */
    .welcome{
      width:min(900px, 96%);
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      padding: 22px;
      box-shadow: 0 22px 80px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      display:none;
    }
    .welcome.on{ display:block; }

    .welcome h2{ margin:0; font-size:28px; letter-spacing:.2px; }
    .welcome p{ margin:8px 0 0; color:var(--muted); line-height:1.5; font-size:14px; }

    .tiles{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:16px;
    }
    .tile{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding:14px;
      min-height:92px;
    }
    .tile strong{ display:block; font-size:13px; margin-bottom:6px; }
    .tile span{ display:block; font-size:12px; color:var(--muted); line-height:1.4; }

    /* Ads container */
    #wiinvent_ads_container_id{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:none;          /* show when ads running */
      z-index: 50;
      pointer-events:auto;
    }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .app{ grid-template-columns:1fr; height:auto; }
      .stage{ min-height:560px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M4 6.5C4 5.12 5.12 4 6.5 4h11C18.88 4 20 5.12 20 6.5v7C20 14.88 18.88 16 17.5 16h-11C5.12 16 4 14.88 4 13.5v-7Z" stroke="white" opacity="0.95" stroke-width="1.6"/>
            <path d="M8 20h8" stroke="white" opacity="0.95" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M12 16v4" stroke="white" opacity="0.95" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>Welcome Screen + Ads Demo</h1>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <strong>Trạng thái</strong>
          <span id="sdkBadge" class="badge">SDK: chưa init</span>
        </div>

        <div class="row">
          <div class="k">TV Power</div>
          <div class="v" id="tvStateText">OFF</div>
        </div>
        <div class="row">
          <div class="k">Ads Container</div>
          <div class="v" id="adsStateText">hidden</div>
        </div>
        <div class="row">
          <div class="k">Init Ads</div>
          <div class="v" id="initAdsText">false</div>
        </div>

        <div class="actions">
          <button id="btnPower" class="btn btn-primary" type="button">
            <span>⏻</span>
            <span>Bật TV</span>
          </button>
          <button id="btnReset" class="btn" type="button">Reset UI</button>
        </div>

        <div class="hint">
          Khi bấm <strong>Bật TV</strong>, demo sẽ:
          (1) bật welcome UI, (2) gọi <code>handleAds()</code>, (3) SDK render ads.
        </div>
      </div>

      <div class="log">
        <pre id="logBox">[ready] Demo loaded.</pre>
      </div>
    </aside>

    <main class="stage">
      <div class="topbar">
        <div class="left">
          <div id="tvDot" class="dot" title="Power indicator"></div>
          <div class="title">Welcome Screen</div>
        </div>
        <div class="right">
          <span id="nowClock">--:--:--</span>
          <span>Environment: SANDBOX</span>
        </div>
      </div>

      <section class="screen">
        <div id="welcomePanel" class="welcome">
          <h2>Chào mừng bạn đến với TV</h2>

          <div class="tiles">
            <div class="tile">
              <strong>Nội dung nổi bật</strong>
              <span>Phim mới, thể thao, live TV…</span>
            </div>
            <div class="tile">
              <strong>Đề xuất</strong>
              <span>Cá nhân hoá theo hành vi người dùng.</span>
            </div>
            <div class="tile">
              <strong>Quảng cáo</strong>
              <span>Pre-roll overlay + custom skip button.</span>
            </div>
          </div>
        </div>

        <!-- TV OFF overlay -->
        <div id="tvOffOverlay" class="tv-off">
          <div class="off-card">
            <h2>TV đang tắt</h2>
            <p>Bấm “Bật TV” để hiển thị welcome screen và gọi quảng cáo (handleAds).</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- SDK script -->
  <script src="https://cdn.jsdelivr.net/gh/KVA24/banner-ad-sdk@welcome.1.0.0/dist/wii-sdk-welcome-tvc.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    function log(...args) {
      const box = $('logBox');
      const line = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
      box.textContent = (box.textContent + "\n" + line).slice(-7000);
      box.scrollTop = box.scrollHeight;
      console.log(...args);
    }

    function setText(id, text) {
      const el = $(id);
      if (el) el.textContent = text;
    }

    function displayEle(ele, display = true) {
      if (!ele) return;
      ele.style.display = display ? 'block' : 'none';
    }

    function visibableEle(ele, visibable = true) {
      if (!ele) return;
      ele.style.visibility = visibable ? 'visible' : 'hidden';
    }

    // Clock
    (function tickClock() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      const ss = String(now.getSeconds()).padStart(2,'0');
      $('nowClock').textContent = `${hh}:${mm}:${ss}`;
      setTimeout(tickClock, 500);
    })();

    // ----------------------------
    // State
    // ----------------------------
    let tvOn = false;
    let initAds = false;
    let wiiSdk = null;

    const adsContainer = $('wiinvent_ads_container_id');
    const welcomePanel = $('welcomePanel');
    const tvOffOverlay = $('tvOffOverlay');

    let skipButton = null;
    let skipTimer = null;

    // ----------------------------
    // TV UI
    // ----------------------------
    function setTV(on) {
      tvOn = !!on;
      $('tvDot').classList.toggle('on', tvOn);
      setText('tvStateText', tvOn ? 'ON' : 'OFF');

      // welcome visible when ON
      welcomePanel.classList.toggle('on', tvOn);

      // overlay visible when OFF
      tvOffOverlay.classList.toggle('hidden', tvOn);

      $('btnPower').innerHTML = tvOn
        ? '<span>⏻</span><span>Tắt TV</span>'
        : '<span>⏻</span><span>Bật TV</span>';

      if (!tvOn) {
        // turn off: stop ads UI
        contentPlayBack();
      }
    }

    // ----------------------------
    // Ads hooks
    // ----------------------------
    function handleAds() {
      if (initAds) {
        log('[handleAds] already initialized -> skip init');
        return;
      }
      initAds = true;
      setText('initAdsText', 'true');
      setText('sdkBadge', 'SDK: init...');

      window.addEventListener("message", function (e) {
        const type = e?.data?.type;
        if (!type) return;

        const allow = [
          "REQUEST","LOADED","START","PAUSED","RESUMED","ERROR","PLAYER_ERROR","CLICK",
          "IMPRESSION","SKIPPED","COMPLETE","DESTROY","FULLSCREEN","END","All_ADS_COMPLETE","NO_ADS","BEGIN","GET_ADS"
        ];
        if (allow.includes(type)) log('[SDK EVENT]', type, e.data);

        if (type === "PLAYER_ERROR") {
          log("==== PLAYER_ERROR ====");
          contentPlayBack();
        }

        if (type === "START") {
          log("==== START ====");
          // show ads overlay
          displayEle(adsContainer, true);
          setText('adsStateText', 'visible');
          renderSkipButton();
          try { wiiSdk && typeof wiiSdk.playAds === 'function' && wiiSdk.playAds(); } catch (err) { log('[wiiSdk.playAds] error', String(err)); }
        }

        if (type === "GET_ADS") {
          log("==== GET_ADS ====");
          try { wiiSdk && wiiSdk.setSource && wiiSdk.setSource(); } catch (err) { log('[wiiSdk.setSource] error', String(err)); }
        }

        if (type === "END" || type === "COMPLETE" || type === "All_ADS_COMPLETE" || type === "NO_ADS") {
          log(`==== ${type} ====`);
          contentPlayBack();
          wiiSdk && wiiSdk.destroy && wiiSdk.destroy();
        }

        if (type === "ERROR") {
          log("==== ERROR ====");
        }
      });

      // Init SDK (fallback mock nếu script chưa load)
      try {
        if (!window.WI || !WI.WelcomeSdk) {
          setText('sdkBadge', 'SDK: missing');
          log('[SDK] WI.WelcomeSdk not found. Kiểm tra ./js/wii-sdk-welcome-tvc.js');
          // mock START
          setTimeout(() => window.postMessage({ type: 'START', mock: true }, '*'), 600);
          return;
        }

        wiiSdk = new WI.WelcomeSdk({
          env: WI.Environment.SANDBOX,
          tenantId: 14,
          deviceType: WI.DeviceType.TV,
          domId: "wiinvent_ads_container_id",
          channelId: "",
          streamId: "1509",
          adId: "1999",
          contentType: WI.ContentType.VIDEO,
          title: "noi dung 1",
          transId: "111",
          category: "1, 2",
          keyword: "1, 2",
          age: "20",
          gender: WI.Gender.MALE,
          uid20: "test",
          manufacturer: "",
          model: "",
          osName: "",
          osVersion: "",
          partnerSkipOffset: 2,
          vastLoadTimeout: 5,
          mediaLoadTimeout: 10,
          bufferingVideoTimeout: 10,
          alwaysCustomSkip: true,
          isAutoRequestFocus: false,
          bitrate: 1024,
          skipText: "Skip ads after {0} seconds",
          skippableText: "Skip ads",
          isUsePartnerSkipButton: true,
          segments: "1,2,3,11,22,33"
        });

        window.wiiSdk = wiiSdk;
        setText('sdkBadge', 'SDK: ready');
        log('[SDK] wiiSdk created. call start()...');
        wiiSdk.start();
      } catch (err) {
        setText('sdkBadge', 'SDK: init error');
        log('[SDK] init error:', String(err));
      }
    }

    function renderSkipButton() {
      // cleanup
      try { if (skipTimer) clearInterval(skipTimer); } catch {}
      skipTimer = null;
      try { if (skipButton && skipButton.parentNode) skipButton.parentNode.removeChild(skipButton); } catch {}
      skipButton = null;

      skipButton = document.createElement('button');
      skipButton.type = 'button';
      skipButton.style.cssText = `
        background-color: #000000;
        color: #fff;
        border: 1px solid rgba(255,255,255,.5);
        border-radius: .5rem;
        padding: .75rem .85rem;
        font-size: 1.05rem;
        line-height: 1.6rem;
        font-family: "Inter",Tahoma,Geneva,Verdana,sans-serif;
        font-weight: 800;
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor: not-allowed;
        visibility: hidden;
      `;
      document.body.appendChild(skipButton);

      let countdown = 5;
      // ưu tiên partnerSkipOffset nếu bạn muốn align theo SDK
      const cfgOffset = (wiiSdk && wiiSdk.partnerSkipOffset != null) ? Number(wiiSdk.partnerSkipOffset) : null;
      if (Number.isFinite(cfgOffset) && cfgOffset >= 0) countdown = cfgOffset;

      const icon = `
        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 320 512" style="margin-left:8px">
          <path fill="#fff" d="M52.5 440.6c-9.5 7.9-22.8 9.7-34.1 4.4S0 428.4 0 416V96C0 83.6 7.2 72.3 18.4 67s24.5-3.6 34.1 4.4l192 160L256 241V96c0-17.7 14.3-32 32-32s32 14.3 32 32V416c0 17.7-14.3 32-32 32s-32-14.3-32-32V271l-11.5 9.6-192 160z"/>
        </svg>
      `;

      const textSkip = (n) => `Skip sau ${Math.max(0,n)}s ${icon}`;
      const textDone = () => `Skip ads ${icon}`;

      skipButton.disabled = true;

      const doSkip = () => {
        if (countdown > 0) return;
        log('[UI] Skip pressed');
        try { wiiSdk && typeof wiiSdk.skip === 'function' && wiiSdk.skip(); } catch (err) { log('[wiiSdk.skip] error', String(err)); }
        contentPlayBack();
      };

      skipButton.addEventListener('click', doSkip);
      window.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.keyCode === 13) doSkip();
      }, { passive: true });

      const tick = () => {
        if (!skipButton) return;

        visibableEle(skipButton, true);

        if (countdown <= 0) {
          skipButton.disabled = false;
          skipButton.style.cursor = 'pointer';
          skipButton.innerHTML = textDone();
        } else {
          skipButton.disabled = true;
          skipButton.style.cursor = 'not-allowed';
          skipButton.innerHTML = textSkip(countdown);
        }

        countdown -= 1;
      };

      tick();
      skipTimer = setInterval(() => {
        if (!skipButton) {
          clearInterval(skipTimer);
          skipTimer = null;
          return;
        }
        tick();
      }, 1000);
    }

    function contentPlayBack() {
      // stop skip timer
      try { if (skipTimer) clearInterval(skipTimer); } catch {}
      skipTimer = null;

      // remove skip btn
      try {
        document.body.removeChild(skipButton);
      } catch {}
      skipButton = null;

      // hide ads container
      displayEle(adsContainer, false);
      setText('adsStateText', 'hidden');
    }

    // Buttons
    $('btnPower').addEventListener('click', () => {
      if (!tvOn) {
        setTV(true);
        log('[UI] Power ON -> call handleAds()');
        handleAds();
      } else {
        log('[UI] Power OFF');
        setTV(false);
      }
    });

    $('btnReset').addEventListener('click', () => {
      log('[UI] Reset');
      initAds = false;
      wiiSdk = null;
      setText('initAdsText', 'false');
      setText('sdkBadge', 'SDK: chưa init');
      setTV(false);
      $('logBox').textContent = '[ready] Reset done.';
    });

    // init
    setTV(false);
  </script>
</body>
</html>
